<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Replica√ß√£o PostgreSQL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <main class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl p-6 sm:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Monitor de Replica√ß√£o</h1>
            <p class="text-gray-400 mt-2">Status das replica√ß√µes PostgreSQL - Pedroso Inform√°tica</p>
        </header>

        <div class="text-center mb-8">
            <button id="verifyButton" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-500/50">
                <span class="flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    Verificar Replica√ß√µes
                </span>
            </button>
        </div>

        <!-- √Årea de Resultados -->
        <div id="results-container" class="bg-gray-900/50 rounded-xl p-4 sm:p-6 min-h-[300px] transition-all duration-300">
            <div id="placeholder" class="text-center text-gray-500 flex flex-col items-center justify-center h-full">
                 <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mb-4"><path d="M12 12h.01"/><path d="M12 6h.01"/><path d="M12 18h.01"/><path d="M18.36 18.36h.01"/><path d="M5.64 5.64h.01"/><path d="M18.36 5.64h.01"/><path d="M5.64 18.36h.01"/></svg>
                <p>Aguardando verifica√ß√£o...</p>
                <p class="text-sm mt-1">Clique no bot√£o acima para iniciar.</p>
            </div>
            <div id="loader" class="hidden text-center text-cyan-400 flex flex-col items-center justify-center h-full">
                <svg class="animate-spin h-10 w-10 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg">Verificando... Isso pode levar um momento.</p>
            </div>
            <div id="results" class="hidden font-mono text-sm space-y-2"></div>
        </div>
        
        <footer class="text-center mt-6 text-xs text-gray-500">
             <p id="footer-text">Verifica√ß√£o ser√° feita em tempo real.</p>
        </footer>
    </main>

    <script>
        const verifyButton = document.getElementById('verifyButton');
        const resultsContainer = document.getElementById('results');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const footerText = document.getElementById('footer-text');

        // Mapeamento de status para classes de cor do Tailwind CSS
        const statusColors = {
            'ok': 'text-green-400',
            'aviso': 'text-yellow-400',
            'erro': 'text-red-400',
            'titulo': 'text-cyan-400 font-bold'
        };
        
        // Mapeamento de status para √≠cones SVG
        const statusIcons = {
            'ok': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-green-400"><path d="M20 6 9 17l-5-5"/></svg>',
            'aviso': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-yellow-400"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>',
            'erro': '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2 text-red-400"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',
        }

        verifyButton.addEventListener('click', async () => {
            // Inicia o estado de carregamento
            verifyButton.disabled = true;
            verifyButton.classList.add('opacity-50', 'cursor-not-allowed');
            placeholder.classList.add('hidden');
            results.classList.add('hidden');
            loader.classList.remove('hidden');
            resultsContainer.innerHTML = ''; // Limpa resultados anteriores

            const startTime = new Date();
            footerText.textContent = `Iniciando verifica√ß√£o em ${startTime.toLocaleTimeString()}...`;

            try {
                // A URL '/api/check_replication' √© um endpoint padr√£o da Vercel
                // que ir√° executar o arquivo 'api/check_replication.py'.
                const response = await fetch('/api/check_replication');
                
                if (!response.ok) {
                     const errorData = await response.json();
                     throw new Error(errorData.error || `Erro na API: ${response.statusText}`);
                }
                
                const data = await response.json();

                // Esconde o loader e mostra os resultados
                loader.classList.add('hidden');
                results.classList.remove('hidden');

                // Adiciona o cabe√ßalho
                const header = document.createElement('div');
                header.className = `${statusColors['titulo']} mb-3`;
                header.textContent = data.header;
                resultsContainer.appendChild(header);

                // Adiciona cada resultado
                data.results.forEach(item => {
                    const resultDiv = document.createElement('div');
                    const colorClass = statusColors[item.tag] || 'text-gray-400';
                    const icon = statusIcons[item.tag] || '';
                    resultDiv.className = `${colorClass} whitespace-pre-wrap`; // Permite quebra de linha e espa√ßamento
                    resultDiv.innerHTML = `${icon}${item.msg}`; // innerHTML para renderizar o SVG
                    resultsContainer.appendChild(resultDiv);
                });
                
                const endTime = new Date();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                footerText.textContent = `Verifica√ß√£o conclu√≠da em ${duration} segundos.`;
                
                const footer = document.createElement('div');
                footer.className = `${statusColors['titulo']} mt-3`;
                footer.textContent = "üèÅ Verifica√ß√£o conclu√≠da.";
                resultsContainer.appendChild(footer);


            } catch (error) {
                console.error("Falha ao buscar dados da replica√ß√£o:", error);
                loader.classList.add('hidden');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-red-400 text-center';
                errorDiv.textContent = `Ocorreu um erro: ${error.message}`;
                resultsContainer.appendChild(errorDiv);
                footerText.textContent = `Erro durante a verifica√ß√£o.`;
            } finally {
                // Reabilita o bot√£o
                verifyButton.disabled = false;
                verifyButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    </script>
</body>
</html>
